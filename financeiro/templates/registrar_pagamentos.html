{% extends "templates/base.html" %}
{% comment %} {% extends "templates/base.html" %}

{% block content %}
<h2>Registrar pagamento - {{ conta }}</h2>

<form method="post">
  {% csrf_token %}
  <div>
    <label>Valor Pago:</label>
    <input type="number" name="valor_pago" step="0.01" required>
  </div>

  <div>
    <label>Forma de Pagamento:</label>
    <select name="forma_pagamento" required>
      {% for tipo, nome in conta.TIPO_CONTA_CHOICES %}
        <option value="{{ tipo }}">{{ nome }}</option>
      {% endfor %}
    </select>
  </div>

  <div>
    <label>Observa√ß√£o:</label>
    <textarea name="observacao"></textarea>
  </div>

  <div class="valor_devedor">
    {{conta.saldo}}
  </div>

  <button type="submit">Registrar</button>
</form>

<hr>

<h3>Pagamentos realizados:</h3>
<table border="1" cellpadding="5">
  <tr>
    <th>Data</th>
    <th>Valor</th>
    <th>Forma</th>
    <th>Tipo</th>
    <th>Usu√°rio</th>
    <th>A√ß√µes</th>
  </tr>
  {% for p in conta.pagamentos.all %}
  <tr>
    <td>{{ p.data_pagamento }}</td>
    <td>{{ p.valor_pago }}</td>
    <td>{{ p.forma_pagamento }}</td>
    <td>{{ p.tipo_lancamento }}</td>
    <td>{{ p.usuario }}</td>
    <td>
      {% if p.tipo_lancamento == 'NORMAL' %}
        <a href="{% url 'estornar_pagamento' p.id %}">Estornar</a>
      {% endif %}
    </td>
  </tr>
  {% empty %}
  <tr><td colspan="6">Nenhum pagamento registrado</td></tr>
  {% endfor %}
</table>

{% endblock %} {% endcomment %}


{% block content %}
<h2>Contas a Pagar</h2>

<form method="get" class="filtros">
  <label>Data Inicial:</label>
  <input type="date" name="data_inicial" value="{{ filtros.data_inicial }}">
  
  <label>Data Final:</label>
  <input type="date" name="data_final" value="{{ filtros.data_final }}">

  <label>Fornecedor:</label>
  <input type="text" name="fornecedor" value="{{ filtros.fornecedor }}" placeholder="Nome do fornecedor">

  <button type="submit">Filtrar</button>
</form>

<hr>

<form method="post" id="formBaixa">
  {% csrf_token %}

  <div class="linha-baixa-tudo">
    <label><strong>Data padr√£o:</strong></label>
    <input type="date" name="data_padrao" id="data_padrao" value="{{ today|date:'Y-m-d' }}">

    <label><strong>Forma padr√£o:</strong></label>
    <select name="forma_padrao" id="forma_padrao">
      {% for forma in formas_pagamento %}
          <option value="{{ forma.id }}"
            {% if forma.nome == "Boleto" %}selected{% endif %}>
            {{ forma.nome }}
          </option>
      {% endfor %}
    </select>

    <button type="submit" class="btn btn-success">
      üí∞ Baixar selecionadas
    </button>
  </div>

  <br>

  <table border="1" cellpadding="6" width="100%">
    <tr>
      
      <th>Fornecedor</th>
      <th>Descri√ß√£o</th>
      <th>Vencimento</th>
      <th>Valor Total</th>
      <th>Saldo</th>
      <th>Valor Pago</th>
      <th>Data Pagamento</th>
      <th>Forma</th>
      <th><input type="checkbox" id="selecionar_todas"></th>
    </tr>

    {% for conta in contas %}
      <tr>
        
        <td>{{ conta.cod_cliente }}</td>
        <td>{{ conta.descricao }}</td>
        <td>{{ conta.dt_vencimento|date:"d/m/Y" }}</td>
        <td>R$ {{ conta.valor_total|floatformat:2 }}</td>
        <td>R$ {{ conta.saldo|floatformat:2 }}</td>

        <td><input type="number" step="0.01" name="valor_pago_{{ conta.pk }}" value="{{ conta.saldo }}" style="width: 90px;"></td>
        <td><input type="date" name="data_pg_{{ conta.pk }}" value="{{ today|date:'Y-m-d' }}"></td>

        <td>
          <select name="forma_{{ conta.pk }}">
            {% for forma in formas_pagamento %}
              <option value="{{ forma.id }}"
                {% if forma.nome == "Boleto" %}selected{% endif %}>
                {{ forma.nome }}
              </option>
            {% endfor %}
          </select>
        </td>

        <td>
          <input type="checkbox" name="selecionadas" value="{{ conta.pk }}" class="checkbox-conta">
        </td>
      </tr>
    {% empty %}
      <tr><td colspan="9">Nenhuma conta encontrada</td></tr>
    {% endfor %}
  </table>

</form>

<script>
  // Aplicar data padr√£o a todos os campos
  document.getElementById('data_padrao').addEventListener('change', function() {
    const novaData = this.value;
    document.querySelectorAll('input[type="date"][name^="data_pg_"]').forEach(el => {
      el.value = novaData;
    });
  });

  // Aplicar forma padr√£o a todos os selects
  document.getElementById('forma_padrao').addEventListener('change', function() {
    const novaForma = this.value;
    document.querySelectorAll('select[name^="forma_"]').forEach(sel => {
      sel.value = novaForma;
    });
  });

  // Selecionar / desmarcar todas
  document.getElementById('selecionar_todas').addEventListener('change', function() {
    const marcado = this.checked;
    document.querySelectorAll('.checkbox-conta').forEach(chk => chk.checked = marcado);
  });
</script>

{% endblock %}

