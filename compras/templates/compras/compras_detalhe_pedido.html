{% extends "templates/base_2.html" %}
{% load static %}
{% block content %}

<h2>Pedido {{ pedido.numero }}</h2>

<p><strong>Fornecedor:</strong> {{ pedido.fornecedor }}</p>
<p><strong>Valor Total:</strong> R$ {{ pedido.valor_total }}</p>
<p><strong>Antecipado:</strong> R$ {{ total_antecipado }}</p>
<p><strong>Recebido:</strong> R$ {{ pedido.valor_recebido }}</p>
<p><strong>Status:</strong> {{ pedido.status }}</p>

<a href="{% url 'compras:compras_editar_pedido' pedido.id %}" class="btn btn-primary">Editar Pedido</a>

<hr>

<h3>Itens do Pedido</h3>

<table class="table">
    <thead>
        <tr>
            <th>Produto</th>
            <th>Qtde</th>
            <th>Recebida</th>
            <th>V. Unit</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {% for item in itens %}
        <tr>
            <td>{{ item.produto }}</td>
            <td>{{ item.quantidade }}</td>
            <td>{{ item.quantidade_recebida }}</td>
            <td>R$ {{ item.valor_unitario }}</td>
            <td>
                <a href="{% url 'compras:compras_remover_item' pedido.id item.id %}" class="btn btn-danger btn-sm">X</a>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="5" class="text-center">Nenhum item cadastrado.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<hr>

<h3>Adicionar Itens</h3>

<table style="display:none">
    <tbody>
        <tr id="form-vazio">
            <td>
                {{ formset.empty_form.codigo_produto }}
                {{ formset.empty_form.produto }}
                <div class="produto-nome text-muted"></div>
                <div class="produto-estoque text-muted"></div> <!-- div reservada -->
            </td>
            <td>{{ formset.empty_form.quantidade }}</td>
            <td>{{ formset.empty_form.valor_unitario }}</td>
        </tr>

    </tbody>
</table>

<form method="post" action="{% url 'compras:compras_adicionar_item' pedido.id %}">
    {% csrf_token %}

    {{ formset.management_form }}

    <table id="tabela-itens" class="table">
        <tbody>
            {% for form in formset %}
            <tr class="item-form">
                <td>
                    {{ form.codigo_produto }}
                   
                </td>

                <td>{{ form.quantidade }}</td>
                <td>{{ form.valor_unitario }}</td>
            </tr>
            {% endfor %}
        </tbody>
        
    </table>
    
    
    <button type="button"
            class="btn btn-success add-item-antecipacao">
        + Adicionar linha
    </button>

    <button type="submit" class="btn btn-primary">
        Salvar itens
    </button>
</form>

<br>

<a href="{% url 'compras:compras_adicionar_antecipacao' pedido.id %}"
   class="btn btn-warning"
   style="padding: 8px 14px; display: inline-block; text-decoration: none;">
    Antecipar Pagamento
</a>
<hr>

<h3>Antecipações</h3>

<table class="table">
    <thead>
        <tr>
            <th>Data</th>
            <th>Valor</th>
        </tr>
    </thead>
    <tbody>
        {% for ant in antecipacoes %}
        <tr>
            
            <td>R$ {{ ant.valor }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="2" class="text-center">Nenhuma antecipação registrada.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Botão para abrir o modal -->
<button id="btnAbrirAntecipacao"
        class="btn btn-warning"
        data-valor="{{ pedido.valor_total }}"
        onclick="abrirModalAntecipacao()">
    Adicionar Antecipação
</button>

<!-- Modal -->
<div id="modalAntecipacao" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5);">
    <div style="background:#fff; max-width:400px; margin:100px auto; padding:20px; border-radius:8px; position:relative;">
        <h4>Registrar Antecipação</h4>
        <form method="post" action="{% url 'compras:compras_adicionar_antecipacao' pedido.id %}">
            {% csrf_token %}
            
            <div class="mb-2">
                <label>
                    <input type="radio" name="tipo" value="total" checked onclick="preencherValor()">
                    Total
                </label>

                <label>
                    <input type="radio" name="tipo" value="parcial" onclick="limparValor()">
                    Parcial
                </label>
            </div>

            <div class="mb-2">
                <label for="valor">Valor:</label>
                <input type="number" step="0.01" id="valorAntecipacao" name="valor" class="form-control" required>

            </div>

            <div class="mb-2">
                <label for="observacao">Observação (opcional):</label>
                <input type="text" name="observacao" id="observacaoAntecipacao" class="form-control">
            </div>

            <button class="btn btn-warning" type="submit">Adicionar</button>
            <button type="button" class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
        </form>
    </div>
</div>
<script src="{% static "/javascript/compras.js" %}"></script>
<script src="{% static "/javascript/buscar_produto.js" %}"></script>

{% endblock %}
